name: Update Packages

on:
  schedule:
    # Run weekly on Sundays at 6:00 AM UTC
    - cron: '0 6 * * 0'
  # Allow manual triggering
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Nix
      uses: cachix/install-nix-action@v24
      with:
        nix_path: nixpkgs=channel:nixos-unstable

    - name: Update Nix channels
      run: |
        nix-channel --add https://nixos.org/channels/nixos-unstable nixpkgs
        nix-channel --update

    - name: Check for package updates
      id: update
      run: |
        echo "Checking for package updates..."

        # Make the update script executable
        chmod +x ./update-packages.sh

        # Run the update script and capture output
        if ./update-packages.sh; then
          echo "Updates completed successfully"

          # Check if there are any changes
          if git diff --quiet; then
            echo "No updates available"
            echo "has_updates=false" >> $GITHUB_OUTPUT
          else
            echo "Updates found!"
            echo "has_updates=true" >> $GITHUB_OUTPUT

            # Get the list of updated packages
            # updated_packages=$(git diff --name-only | grep -E 'pkgs/.*/default.nix' | sed 's|pkgs/\(.*\)/default.nix|\1|' | tr '\n' ' ')
            updated_packages=$(
              git diff --name-only |
              grep -E '^pkgs/[^/]+/default\.nix$' |
              cut -d/ -f2 |
              tr '\n' ' '
            )
            echo "updated_packages=$updated_packages" >> $GITHUB_OUTPUT
          fi
        else
          echo "Update script failed"
          exit 1
        fi

    - name: Test updated packages
      if: steps.update.outputs.has_updates == 'true'
      run: |
        echo "Testing updated packages..."

        # Build all packages to ensure they still work
        for package in ${{ steps.update.outputs.updated_packages }}; do
          echo "Building $package..."
          nix-build -A "$package" --show-trace
        done

    - name: Create Pull Request
      if: steps.update.outputs.has_updates == 'true'
      uses: peter-evans/create-pull-request@v7
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: |
          Update packages: ${{ steps.update.outputs.updated_packages }}

          Automated package updates using nvfetcher.
        title: 'Update packages: ${{ steps.update.outputs.updated_packages }}'
        body: |
          ## Automated Package Updates

          This PR contains automated package updates detected by nvfetcher:

          **Updated packages:** ${{ steps.update.outputs.updated_packages }}

          ### Changes
          - Package versions and checksums have been automatically updated
          - All packages have been tested and build successfully

          ### Verification
          - ✅ All updated packages build without errors
          - ✅ Package metadata and checksums are valid

          This PR was automatically created by the package update workflow.
        branch: automated-package-updates
        branch-suffix: timestamp
        delete-branch: true
